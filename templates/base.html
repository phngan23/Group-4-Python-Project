{% load static %}

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Study Tracker</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="{% static 'css/style.css' %}" />
    <link rel="stylesheet" href="{% static 'css/responsive.css' %}" />

    {% block extra_css %}{% endblock %}
  </head>

  <body>
    <!-- Sidebar Navigation -->
    <div class="sidebar">
      <div class="logo">
        <i class="fas fa-graduation-cap"></i>
      </div>

      <a
        href="/"
        class="nav-item {% if active_page == 'home' %}active{% endif %}"
      >
        <i class="fas fa-home"></i>
      </a>

      <a
        href="{% url 'study:timer' %}"
        class="nav-item {% if active_page == 'timer' %}active{% endif %}"
      >
        <i class="fas fa-clock"></i>
      </a>

      <a
        href="{% url 'gamification:shop' %}"
        class="nav-item {% if active_page == 'gamification' %}active{% endif %}"
      >
        <i class="fas fa-store"></i>
      </a>

      <a
        href="{% url 'visualization:study_stats' %}"
        class="nav-item {% if active_page == 'statistics' %}active{% endif %}"
      >
        <i class="fas fa-chart-bar"></i>
      </a>

      <a
        href="{% url 'emotion:emotion_history' %}"
        class="nav-item {% if active_page == 'emotion' %}active{% endif %}"
      >
        <i class="fas fa-smile"></i>
      </a>

      <a
        href="/music/"
        class="nav-item {% if active_page == 'music' %}active{% endif %}"
      >
        <i class="fas fa-music"></i>
      </a>

      <a
        href="{% url 'todo:todo_list' %}"
        class="nav-item {% if active_page == 'todo' %}active{% endif %}"
      >
        <i class="fas fa-tasks"></i>
      </a>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Header-->
      <div class="header">

        <div class="mini-clock-container" id="mini-clock-container" style="display: none;">
          <div class="mini-clock">
            <span class="mini-clock-icon">‚è∞</span>
            <span class="mini-clock-time" id="mini-clock-time">25:00</span>
            <span class="mini-clock-mode" id="mini-clock-mode">Study</span>
          </div>
        </div>

        <div class="user-info">
          {% if request.user.is_authenticated %}
          <!-- Khi ƒë√£ ƒëƒÉng nh·∫≠p -->
          <div class="avatar">{{ request.user.username|first|upper }}</div>
          <div>
            <h2>Hello, {{ request.user.username }}!</h2>
            <p>Ready to study today?</p>
          </div>
          {% else %}
          <!-- Khi ch∆∞a ƒëƒÉng nh·∫≠p -->
          <div>
            <h2>Welcome!</h2>
            <p>Please log in to start tracking.</p>
          </div>
          {% endif %}
        </div>

        <div
          class="header-right"
          style="display: flex; align-items: center; gap: 20px"
        >
          <div class="date-display">
            <p id="current-date">Thursday, November 13, 2025</p>
          </div>

          <!-- Ph·∫ßn hi·ªÉn th·ªã xu n·∫øu ƒë√£ ƒëƒÉng nh·∫≠p-->
          {% if request.user.is_authenticated %}
          <div
            class="auth-buttons"
            style="display: flex; gap: 15px; align-items: center"
          >
            <a
              href="{% url 'logout' %}"
              class="btn-login"
              style="font-weight: bold"
              >ƒêƒÉng xu·∫•t
            </a>
          </div>

          <div class="coin-display">
            <span class="coin-icon">üí∞</span>
            <span id="coinCount">{{ request.user.profile.coins }}</span> Coins
          </div>

          {% else %}
          <!-- Hi·ªÉn th·ªã Login + Register -->
          <div
            class="auth-buttons"
            style="display: flex; gap: 15px; align-items: center"
          >
            <a
              href="{% url 'login' %}"
              class="btn-login"
              style="font-weight: bold"
              >ƒêƒÉng nh·∫≠p
            </a>

            <a
              href="{% url 'register' %}"
              class="btn-register"
              style="font-weight: bold"
              >ƒêƒÉng k√Ω
            </a>
          </div>
          {% endif %}
        </div>
      </div>

      <!-- Content here-->
      {% block content %} {% endblock %}
    </div>
    <!-- Decorative Elements -->
    <div class="sky"></div>
    <div class="cloud cloud-1"></div>
    <div class="cloud cloud-2"></div>
    <div class="grass"></div>
    <div class="mascot"></div>

    <!-- Scripts -->
    <script src="{% static 'js/app.js' %}"></script>
    <script src="{% static 'js/characters.js' %}"></script>

    <!-- Global Music Player Script - TH√äM V√ÄO ƒê√ÇY -->
    <script>
    // Kh·ªüi t·∫°o global music player tr√™n m·ªçi page
    if (!window.globalMusicPlayer) {
        window.globalMusicPlayer = {
            audioPlayer: new Audio(),
            isPlaying: false,
            currentTrack: null,
            tracks: [],
            currentIndex: 0
        };
    }

    // T·ª± ƒë·ªông kh√¥i ph·ª•c nh·∫°c khi load b·∫•t k·ª≥ page n√†o
    document.addEventListener('DOMContentLoaded', function() {
        const savedState = sessionStorage.getItem('musicPlayerState');
        if (savedState) {
            const state = JSON.parse(savedState);
            if (state.currentTrack && state.isPlaying) {
                const audio = window.globalMusicPlayer.audioPlayer;
                audio.src = state.currentTrack.audio_url;
                audio.currentTime = state.currentTime || 0;
                audio.play().catch(console.error);
                
                // C·∫≠p nh·∫≠t global state
                window.globalMusicPlayer.isPlaying = true;
                window.globalMusicPlayer.currentTrack = state.currentTrack;
                window.globalMusicPlayer.currentIndex = state.currentIndex;
            }
        }
    });
    </script>

    <script>
    // Global Mini Clock Manager - CH·∫†Y TR√äN T·∫§T C·∫¢ TRANG
      document.addEventListener('DOMContentLoaded', function() {
          initializeGlobalMiniClock();
      });

      function initializeGlobalMiniClock() {
          let miniClockInterval = null;
          
          function updateMiniClock() {
              try {
                  const savedStateRaw = localStorage.getItem('pomodoroState');
                  if (!savedStateRaw) {
                      hideMiniClock();
                      return;
                  }
                  
                  const savedState = JSON.parse(savedStateRaw);
                  const container = document.getElementById('mini-clock-container');
                  const timeDisplay = document.getElementById('mini-clock-time');
                  const modeDisplay = document.getElementById('mini-clock-mode');
                  
                  if (!container || !timeDisplay) return;
                  
                  // CH·ªà HI·ªÇN TH·ªä KHI TIMER ƒêANG CH·∫†Y TH·ª∞C S·ª∞
                  if (savedState.isRunning && !savedState.isPaused) {
                      container.style.display = 'block';
                      
                      // T√≠nh th·ªùi gian th·ª±c t·∫ø
                      const now = Date.now();
                      const lastSaved = savedState.lastSavedTime || now;
                      const elapsed = Math.floor((now - lastSaved) / 1000);
                      const currentTimeLeft = Math.max(0, savedState.timeLeft - elapsed);
                      
                      // C·∫≠p nh·∫≠t hi·ªÉn th·ªã
                      const minutes = Math.floor(currentTimeLeft / 60);
                      const seconds = currentTimeLeft % 60;
                      timeDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                      
                      if (modeDisplay) {
                          const modeNames = {
                              'pomodoro': 'Study',
                              'shortBreak': 'Break', 
                              'longBreak': 'Break'
                          };
                          modeDisplay.textContent = modeNames[savedState.currentMode] || 'Timer';
                      }
                      
                      console.log("MiniClock updated:", { currentTimeLeft, elapsed, running: savedState.isRunning });
                      
                  } else {
                      hideMiniClock();
                  }
              } catch (error) {
                  console.error('Error updating mini clock:', error);
                  hideMiniClock();
              }
          }
          
          function hideMiniClock() {
              const container = document.getElementById('mini-clock-container');
              if (container) {
                  container.style.display = 'none';
              }
              if (miniClockInterval) {
                  clearInterval(miniClockInterval);
                  miniClockInterval = null;
              }
          }
          
          // B·∫Øt ƒë·∫ßu c·∫≠p nh·∫≠t mini clock
          miniClockInterval = setInterval(updateMiniClock, 1000);
          updateMiniClock(); // Ch·∫°y ngay l·∫ßn ƒë·∫ßu
          
          // L∆∞u interval ƒë·ªÉ clear khi c·∫ßn
          window.miniClockInterval = miniClockInterval;
      }
    </script>
    
    {% block scripts %}{% endblock %}
  </body>
</html>