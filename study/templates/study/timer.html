{% extends "base.html" %}
{% load static %}

{% block title %}Pomodoro{% endblock %}

{% block content %}

    <!-- Pomodoro Page -->
    <div class="page active" id="pomodoro">
        
        <h1 class="page-title">Pomodoro Timer</h1>

        <!-- Subject + View History on the same row -->
        <div class="subject-row">

            <!-- LEFT: SUBJECT SELECT -->
            <div class="subject-left">
                <label for="subjectSelect" class="block mb-1 font-semibold">Subject</label>

                <select id="subjectSelect" class="subject-select">
                    <option value="">-- Select subject --</option>

                    {% for sub in subjects %}
                        <option value="{{ sub.id }}">{{ sub.name }}</option>
                    {% endfor %}

                    <option value="new">â• Add new subject</option>
                </select>
            </div>

            <!-- RIGHT: VIEW HISTORY BUTTON -->
            <div class="subject-right">
                <a href="{% url 'study:history' %}" class="history-btn">
                    <i class="fas fa-history"></i>
                    <span>View History</span>
                </a>
            </div>
        </div>

        <!-- Modal: Add New Subject -->
        <div id="subjectModal" class="modal hidden">
            <div class="modal-content">
                <h2>Add New Subject</h2>
                <input type="text" id="modalSubjectName" placeholder="Subject name">
                <div class="modal-actions">
                    <button id="cancelModal" class="cancel-btn">Cancel</button>
                    <button id="saveModal" class="save-btn">Save</button>
                </div>
            </div>
        </div>

        <!-- Pomodoro Timer -->
        <div class="pomodoro-top-section">
            <div class="pomodoro-container">
                <div class="timer-mode">
                    <button class="mode-btn active" data-mode="pomodoro">Study Time</button>
                    <button class="mode-btn" data-mode="shortBreak">Short Break</button>
                    <button class="mode-btn" data-mode="longBreak">Long Break</button>
                </div>
            
                <div class="timer-display" id="timer-display">25:00</div>
            
                <div class="timer-controls">
                    <!--<button class="timer-btn" id="start-btn">Start</button>
                    <button class="timer-btn secondary" id="stop-btn" disabled>Stop</button>-->
                    
                    <button class="timer-btn wide-btn" id="toggle-btn">Start</button>
                    <button class="timer-btn secondary" id="reset-btn">Reset</button>
                </div>
            
                <div class="current-session">
                    <p>Current Session: <span id="current-session-type">Study Time</span></p>
                    <p>Target: <span id="target-time">25 minutes</span></p>
                </div>
            
                <p id="timer-message">Select your study duration and press Start</p>
            </div>

            <div class="pomodoro-character-area">
                <img
                    id="current-pomo-character"
                    src="{% if active_character %}{{ active_character.image_idle.url }}{% else %}{% static 'assets/images/char1.png' %}{% endif %}"
                    alt="My Character"
                />
                <div class="character-shadow"></div>
            </div>
        </div>

        <!-- Study Progress -->
        <div class="study-progress">
            <div class="progress-header">
                <span>Study Progress</span>
                <span id="progress-text">{{ study_minutes }} minutes</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
            </div>
            <div class="progress-text" id="progress-message">Study to earn coins!</div>
        </div>

        <!-- Custom Time Selection -->
            <div class="time-presets">
                <h3>Select Study Duration</h3>
                <div class="preset-buttons">
                    <button class="preset-btn" data-minutes="30">30 mins</button>
                    <button class="preset-btn" data-minutes="60">60 mins</button>
                    <button class="preset-btn" data-minutes="90">1h 30m</button>
                    <button class="preset-btn" data-minutes="120">2 hours</button>
                </div>

                <div class="custom-time">
                    <label for="custom-minutes">Or set custom time (minutes):</label>
                    <input type="number" id="custom-minutes" min="1" max="240" placeholder="Enter minutes">
                    <button id="set-custom-time">Set Time</button>
                </div>
            </div>

        </div> 
    </div> <!-- End Pomodoro Page -->

    <!-- Emotion Modal (popup cáº£m xÃºc sau khi há»c xong) -->
    <div class="emotion-modal hidden" id="emotionModal">
        <div class="emotion-modal-backdrop" id="emotion-modal-backdrop"></div>
        <div class="emotion-modal-content">
            <p id="study-summary-text" class="study-summary-text"></p>

            <h3>How did this study session feel?</h3>
            <p class="emotion-subtitle">Choose a mood to reflect this session</p>

            <div class="emotion-options" id="emotion-options">
                <button class="emotion-option" data-emotion="happy">ğŸ˜Š Happy</button>
                <button class="emotion-option" data-emotion="sad">ğŸ˜¢ Sad</button>
                <button class="emotion-option" data-emotion="tired">ğŸ˜´ Tired</button>
                <button class="emotion-option" data-emotion="calm">ğŸ˜Œ Calm</button>
                <button class="emotion-option" data-emotion="stressed">ğŸ˜¤ Stressed</button>
                <button class="emotion-option" data-emotion="excited">ğŸ¤© Excited</button>
            </div>

            <div class="emotion-notes">
                <label for="emotion-notes-input">Notes (optional)</label>
                <textarea id="emotion-notes-input" placeholder="What made you feel this way?"></textarea>
            </div>

            <div class="emotion-actions">
                <button id="emotion-save-btn" class="save-btn" disabled>Save Emotion</button>
                <button id="emotion-skip-btn" class="cancel-btn">Skip</button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="confirmation-modal" id="confirmation-modal">
        <div class="modal-content">
            <div class="modal-icon">â°</div>
            <h3>Continue Studying?</h3>
            <p>You have studied for <span id="studied-time">0</span> minutes.</p>
            <p>Do you want to continue?</p>
            <div class="confirmation-actions">
                <button class="confirm-btn" id="continue-studying">Yes, I'm still studying</button>
                <button class="cancel-btn" id="finish-studying">No, I'm done with my studies</button>
            </div>
        </div>
    </div>

    <script>
    window.activeCharacter = {
        image: "{% if active_character %}{{ active_character.image_idle.url }}{% else %}{% static 'assets/images/char1.png' %}{% endif %}"
    };
    </script>

    <script src="{% static 'js/pomodoro.js' %}"></script>

{% endblock %}